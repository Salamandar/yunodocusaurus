"use strict";(self.webpackChunkyunohost_docs=self.webpackChunkyunohost_docs||[]).push([[351],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>h});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var d=n.createContext({}),s=function(e){var t=n.useContext(d),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},p=function(e){var t=s(e.components);return n.createElement(d.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,l=e.originalType,d=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),c=s(a),m=o,h=c["".concat(d,".").concat(m)]||c[m]||u[m]||l;return a?n.createElement(h,r(r({ref:t},p),{},{components:a})):n.createElement(h,r({ref:t},p))}));function h(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var l=a.length,r=new Array(l);r[0]=m;var i={};for(var d in t)hasOwnProperty.call(t,d)&&(i[d]=t[d]);i.originalType=e,i[c]="string"==typeof e?e:o,r[1]=i;for(var s=2;s<l;s++)r[s]=a[s];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},60348:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>r,default:()=>u,frontMatter:()=>l,metadata:()=>i,toc:()=>s});var n=a(87462),o=(a(67294),a(3905));const l={title:"Nextcloud",template:"docs",taxonomy:{category:"docs, apps"},routes:{default:"/app_nextcloud"}},r=void 0,i={unversionedId:"applications/docs/app_nextcloud",id:"applications/docs/app_nextcloud",title:"Nextcloud",description:"Nextcloud's logo",source:"@site/docs/04.applications/10.docs/app_nextcloud.md",sourceDirName:"04.applications/10.docs",slug:"/applications/docs/app_nextcloud",permalink:"/yunodocusaurus/it/docs/applications/docs/app_nextcloud",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/04.applications/10.docs/app_nextcloud.md",tags:[],version:"current",frontMatter:{title:"Nextcloud",template:"docs",taxonomy:{category:"docs, apps"},routes:{default:"/app_nextcloud"}},sidebar:"tutorialSidebar",previous:{title:"Neutrinet",permalink:"/yunodocusaurus/it/docs/applications/docs/app_neutrinet"},next:{title:"KeeWeb for Nextcloud",permalink:"/yunodocusaurus/it/docs/applications/docs/app_nextcloud_keeweb"}},d={},s=[{value:'Discovering the Nextcloud environment <a name="EnvironmentNextcloud" href=""></a>',id:"discovering-the-nextcloud-environment-",level:2},{value:'Mobile and computer client software <a name="ClientSoftware" href=""></a>',id:"mobile-and-computer-client-software-",level:2},{value:'Useful Manipulations &amp; Problems Encountered <a name="UtileManipulations" href=""></a>',id:"useful-manipulations--problems-encountered-",level:2},{value:'Add storage space <a name="AddSpace" href=""></a>',id:"add-storage-space-",level:3},{value:"I. Add an external storage space",id:"i-add-an-external-storage-space",level:4},{value:"II. Migrate Nextcloud data to a larger partition",id:"ii-migrate-nextcloud-data-to-a-larger-partition",level:4},{value:"Choice of location",id:"choice-of-location",level:5},{value:"Migrate data",id:"migrate-data",level:5},{value:"Configure Nextcloud",id:"configure-nextcloud",level:5},{value:"Nextcloud and Cloudflare",id:"nextcloud-and-cloudflare",level:3},{value:"Cloudflare Page Rules",id:"cloudflare-page-rules",level:4},{value:"Add a rule",id:"add-a-rule",level:5},{value:"About Keeweb",id:"about-keeweb",level:2},{value:'Useful links <a name="UsefulLinks" href=""></a>',id:"useful-links-",level:2}],p={toc:s},c="wrapper";function u(e){let{components:t,...a}=e;return(0,o.kt)(c,(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"image://nextcloud_logo.png",alt:"Nextcloud's logo"})),(0,o.kt)("p",null,"Nextcloud is a file hosting service, many applications can be installed to offer it new features such as a calendar, a directory, notes and many others (you can find some applications in the ",(0,o.kt)("a",{parentName:"p",href:"#AppsTiers"},"third-party applications")," part but there are many others depending on your needs)."),(0,o.kt)("h2",{id:"discovering-the-nextcloud-environment-"},"Discovering the Nextcloud environment ",(0,o.kt)("a",{name:"EnvironmentNextcloud",href:""})),(0,o.kt)("p",null,"Due to the creation of Nextcloud, a database with third-party applications to install, this chapter will only concern the nextcloud database without added applications. More information on applications in the dedicated section or in the nextcloud application catalogue: ",(0,o.kt)("a",{parentName:"p",href:"https://apps.nextcloud.com"},"apps.nextcloud.com"),".",(0,o.kt)("br",{parentName:"p"}),"\n","Nextcloud is first and foremost a cloud service (like Seafile and others), it allows synchronization and file sharing on the Internet and between several terminals (computers, smartphone) but also with several people. "),(0,o.kt)("h2",{id:"mobile-and-computer-client-software-"},"Mobile and computer client software ",(0,o.kt)("a",{name:"ClientSoftware",href:""})),(0,o.kt)("p",null,"There are client software for all platforms. You can find them on the official nextcloud website: ",(0,o.kt)("a",{parentName:"p",href:"https://nextcloud.com/install/#install-clients"},"https://nextcloud.com/install/#install-clients")),(0,o.kt)("h2",{id:"useful-manipulations--problems-encountered-"},"Useful Manipulations & Problems Encountered ",(0,o.kt)("a",{name:"UtileManipulations",href:""})),(0,o.kt)("h3",{id:"add-storage-space-"},"Add storage space ",(0,o.kt)("a",{name:"AddSpace",href:""})),(0,o.kt)("p",null,"Solution I. allows you to add a link to a local or remote folder.",(0,o.kt)("br",{parentName:"p"}),"\n","Solution II. allows to move the main storage space of Nextcloud."),(0,o.kt)("h4",{id:"i-add-an-external-storage-space"},"I. Add an external storage space"),(0,o.kt)("p",null,"Parameter =>","[Administration]"," External storage."),(0,o.kt)("p",null,"At the bottom of the list you can add a folder (It is possible to define a subfolder using the ",(0,o.kt)("inlineCode",{parentName:"p"},"folder/subfolder")," convention.)",(0,o.kt)("br",{parentName:"p"}),"\n","Select a storage type and specify the requested connection information.",(0,o.kt)("br",{parentName:"p"}),"\n","You can restrict this folder to one or more nextcloud users with the column ",(0,o.kt)("inlineCode",{parentName:"p"},"Available for"),".",(0,o.kt)("br",{parentName:"p"}),"\n","With the gear you can allow or prohibit previewing and file sharing.",(0,o.kt)("br",{parentName:"p"}),"\n","Finally click on the check mark to validate the folder."),(0,o.kt)("h4",{id:"ii-migrate-nextcloud-data-to-a-larger-partition"},"II. Migrate Nextcloud data to a larger partition"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note"),": The following assumes that you have a hard disk mounted on ",(0,o.kt)("inlineCode",{parentName:"p"},"/media/storage"),". Refer to",(0,o.kt)("a",{parentName:"p",href:"/external_storage"},"this article")," to prepare your system."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Note"),": Replace ",(0,o.kt)("inlineCode",{parentName:"p"},"nextcloud")," with the name of its instance, if you have several Nextcloud apps installed."),(0,o.kt)("p",null,"First turn off the web server with the command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop nginx  \n")),(0,o.kt)("h5",{id:"choice-of-location"},"Choice of location"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Case A: Blank storage, exclusive to Nextcloud")),(0,o.kt)("p",null,"For the moment only root can write to it in ",(0,o.kt)("inlineCode",{parentName:"p"},"/media/storage"),", which means that NGINX and Nextcloud will not be able to use it."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"chown -R nextcloud:nextcloud /media/storage\nchmod 775 -R /media/storage\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Case B: Shared storage, data already present, Nextcloud data in a subfolder")),(0,o.kt)("p",null,"If you want to use this disk for other applications, you can create a subfolder belonging to Nextcloud."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p /media/storage/nextcloud_data\nchown -R nextcloud /media/storage/nextcloud_data\nchmod 775 -R /media/storage/nextcloud_data\n")),(0,o.kt)("h5",{id:"migrate-data"},"Migrate data"),(0,o.kt)("p",null,"Migrate your data to the new disk. To do this ",(0,o.kt)("em",{parentName:"p"},"(be patient, it can take a long time)"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"Case A: cp -ia /home/yunohost.app/nextcloud /media/storage\nCase B: cp -ia /home/yunohost.app/nextcloud /media/storage/nextcloud_data\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"i")," option allows you to ask yourself what to do if there is a file conflict, especially if you overwrite an old Owncloud or Nextcloud data folder.",(0,o.kt)("br",{parentName:"p"}),"\n","To check that everything went well, compare what these two commands display (the content must be identical):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ls -la /home/yunohost.app/nextcloud\n\nCase A: ls -al /media/storage\nCase B: ls -al /media/storage/nextcloud_data/nextcloud\n")),(0,o.kt)("h5",{id:"configure-nextcloud"},"Configure Nextcloud"),(0,o.kt)("p",null,"To inform Nextcloud of its new directory, modify the ",(0,o.kt)("inlineCode",{parentName:"p"},"/var/www/nextcloud/config/config.php")," file with the command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nano /var/www/nextcloud/config/config.php\n")),(0,o.kt)("p",null,"Look for the line:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"'datadirectory' => '/home/yunohost.app/nextcloud/data',\n")),(0,o.kt)("p",null,"That you modify:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"CASE A:'datadirectory' =>'/media/storage',\nCASE B:'datadirectory' =>'/media/storage/nextcloud_data/nextcloud/data',\n")),(0,o.kt)("p",null,"Save it with ",(0,o.kt)("inlineCode",{parentName:"p"},"ctrl+x")," then ",(0,o.kt)("inlineCode",{parentName:"p"},"y")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"o")," (depending on your server locale)."),(0,o.kt)("p",null,"Restart the web server:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start nginx\n")),(0,o.kt)("p",null,"Add the.ocdata file"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"CASE A: nano /media/storage/.ocdata\nCASE B: nano /media/storage/nextcloud_data/nextcloud/data/.ocdata\n")),(0,o.kt)("p",null,"Add a space to the file to be able to save it"),(0,o.kt)("p",null,"Back up with ",(0,o.kt)("inlineCode",{parentName:"p"},"ctrl+x")," then ",(0,o.kt)("inlineCode",{parentName:"p"},"y")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"o")," (depending on your server locale)."),(0,o.kt)("p",null,"Run a scan of the new directory by Nextcloud:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cd /var/www/nextcloud\nsudo -u nextcloud php8.1 --define apc.enable_cli=1 files:scan --all\n")),(0,o.kt)("p",null,"Update the YunoHost setting, so automatic upgrades and backups know where the datadir is located:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"Case A: yunohost app setting nextcloud datadir -v /media/storage\nCase B: yunohost app setting nextcloud datadir -v /media/storage/nextcloud_data/nextcloud/data/\n")),(0,o.kt)("p",null,"It's over now. Now test if everything is fine, try connecting to your Nextcloud instance, upload a file, check its proper synchronization."),(0,o.kt)("h3",{id:"nextcloud-and-cloudflare"},"Nextcloud and Cloudflare"),(0,o.kt)("p",null,"If you use Cloudflare for your DNS, ",(0,o.kt)("em",{parentName:"p"},"which may be useful if you have a dynamic IP"),", you will most likely have authentication problems with the Nextcloud application. On the Internet many people propose to create a rule that disables all options related to security and Cloudflare speed for the URL pointing to your Nextcloud instance. Although it works, it is not the optimal solution. I propose, certainly to create a rule for the URL pointing to your Nextcloud instance but to disable only 2 options. So here's how:"),(0,o.kt)("h4",{id:"cloudflare-page-rules"},"Cloudflare Page Rules"),(0,o.kt)("p",null,"In the Cloudflare control panel select your domain and find Page Rules\nthe URL in your address bar will look like this: ",(0,o.kt)("a",{parentName:"p",href:"https://dash.cloudflare.com/*/domain.tld/page-rules"},"https://dash.cloudflare.com/*/domain.tld/page-rules"),"  "),(0,o.kt)("h5",{id:"add-a-rule"},"Add a rule"),(0,o.kt)("p",null,"The rule to be added must apply to the URL of your Nextcloud instance either:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"https://nextcloud.domain.tld/**")," if you use a subdomain"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"https://domain.tld/nextcloud/*")," if you have deployed Nextcloud in a directory")),(0,o.kt)("p",null,"The options to disable (Off) are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Rocket Loader"),(0,o.kt)("li",{parentName:"ul"},"Email Obfuscation")),(0,o.kt)("p",null,"Save and clean your caches (Cloudflare, browser...) and that's it."),(0,o.kt)("h2",{id:"about-keeweb"},"About Keeweb"),(0,o.kt)("p",null,"The KeeWeb application is a password manager integrated into Nextcloud. For example, it allows you to read a KeePass file (",(0,o.kt)("em",{parentName:"p"},".kdbx"),") stored on your Nextcloud instance.\nBut sometimes Nextcloud does not let the application support these files, which makes it impossible to read them from KeeWeb. To remedy this,\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/jhass/nextcloud-keeweb/blob/master/README.md#mimetype-detection"},"a solution")," exists."),(0,o.kt)("p",null,"Go to the Nextcloud configuration directory:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cd /var/www/nextcloud/config/\n")),(0,o.kt)("p",null,"If it does not exist, create the ",(0,o.kt)("em",{parentName:"p"},"mimetypemapping.json")," file whose owner is the user ",(0,o.kt)("em",{parentName:"p"},"nextcloud")," :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'sudo su nextcloud -c "nano mimetypemapping.json"\n')),(0,o.kt)("p",null,"Then add in this file the following text:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'{\n    "kdbx": ["x-application/kdbx"]\n}\n')),(0,o.kt)("p",null,"Save the file (",(0,o.kt)("strong",{parentName:"p"},"CTRL")," + ",(0,o.kt)("strong",{parentName:"p"},"o"),") and exit nano (",(0,o.kt)("strong",{parentName:"p"},"CTRL")," + ",(0,o.kt)("strong",{parentName:"p"},"c"),")."),(0,o.kt)("p",null,"Then run a scan by executing next command as root:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo -u nextcloud php8.1 --define apc.enable_cli=1 files:scan --all\n")),(0,o.kt)("p",null,"Now the problem is fixed."),(0,o.kt)("h2",{id:"useful-links-"},"Useful links ",(0,o.kt)("a",{name:"UsefulLinks",href:""})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Official website: ",(0,o.kt)("a",{parentName:"li",href:"https://nextcloud.com/"},"nextcloud.com"),"  "),(0,o.kt)("li",{parentName:"ul"},"Application catalogue for Nextcloud: ",(0,o.kt)("a",{parentName:"li",href:"https://apps.nextcloud.com/"},"apps.nextcloud.com"))))}u.isMDXComponent=!0}}]);