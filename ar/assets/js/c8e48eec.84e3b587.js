"use strict";(self.webpackChunkyunohost_docs=self.webpackChunkyunohost_docs||[]).push([[165],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>h});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),u=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},d=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),p=u(a),c=i,h=p["".concat(s,".").concat(c)]||p[c]||m[c]||o;return a?n.createElement(h,l(l({ref:t},d),{},{components:a})):n.createElement(h,l({ref:t},d))}));function h(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=a.length,l=new Array(o);l[0]=c;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r[p]="string"==typeof e?e:i,l[1]=r;for(var u=2;u<o;u++)l[u]=a[u];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},15545:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>r,toc:()=>u});var n=a(87462),i=(a(67294),a(3905));const o={title:"Hooks",template:"docs",taxonomy:{category:"docs"},routes:{default:"/packaging_apps_hooks"}},l=void 0,r={unversionedId:"contribute/packaging_apps/advanced/packaging_apps_hooks",id:"contribute/packaging_apps/advanced/packaging_apps_hooks",title:"Hooks",description:"YunoHost includes a hook mechanism triggered on a lot of operation changing the system. You can use this mechanism in order to extend the behaviour of a YunoHost command.",source:"@site/docs/06.contribute/10.packaging_apps/60.advanced/50.packaging_apps_hooks.md",sourceDirName:"06.contribute/10.packaging_apps/60.advanced",slug:"/contribute/packaging_apps/advanced/packaging_apps_hooks",permalink:"/yunodocusaurus/ar/docs/contribute/packaging_apps/advanced/packaging_apps_hooks",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/06.contribute/10.packaging_apps/60.advanced/50.packaging_apps_hooks.md",tags:[],version:"current",sidebarPosition:50,frontMatter:{title:"Hooks",template:"docs",taxonomy:{category:"docs"},routes:{default:"/packaging_apps_hooks"}},sidebar:"tutorialSidebar",previous:{title:"SSO/LDAP integration",permalink:"/yunodocusaurus/ar/docs/contribute/packaging_apps/advanced/sso_ldap_integration"},next:{title:"Advanced packagers",permalink:"/yunodocusaurus/ar/docs/contribute/packaging_apps/advanced/advanced_packagers"}},s={},u=[{value:"How to add a custom hook on a specific instance",id:"how-to-add-a-custom-hook-on-a-specific-instance",level:2},{value:"How to add a hook in an app package",id:"how-to-add-a-hook-in-an-app-package",level:2},{value:"Hooks referencies",id:"hooks-referencies",level:2},{value:"User and permissions",id:"user-and-permissions",level:3},{value:"post_user_create",id:"post_user_create",level:4},{value:"Environment variables",id:"environment-variables",level:5},{value:"Positionnal arguments (deprecated)",id:"positionnal-arguments-deprecated",level:5},{value:"No waited return",id:"no-waited-return",level:5},{value:"Examples",id:"examples",level:5},{value:"Send automatically a mail to new user",id:"send-automatically-a-mail-to-new-user",level:6},{value:"post_user_delete",id:"post_user_delete",level:4},{value:"No environment variables",id:"no-environment-variables",level:5},{value:"Positionnal arguments",id:"positionnal-arguments",level:5},{value:"No waited return",id:"no-waited-return-1",level:5},{value:"Examples",id:"examples-1",level:5},{value:"post_user_update",id:"post_user_update",level:3},{value:"Environment variables",id:"environment-variables-1",level:5},{value:"No positionnal arguments",id:"no-positionnal-arguments",level:5},{value:"No waited return",id:"no-waited-return-2",level:5},{value:"Examples",id:"examples-2",level:5},{value:"Send a mail on password changing",id:"send-a-mail-on-password-changing",level:6},{value:"post_app_addaccess",id:"post_app_addaccess",level:3},{value:"No environment variables",id:"no-environment-variables-1",level:5},{value:"Positionnal arguments (deprecated)",id:"positionnal-arguments-deprecated-1",level:5},{value:"No waited return",id:"no-waited-return-3",level:5},{value:"Examples",id:"examples-3",level:5},{value:"post_app_removeaccess",id:"post_app_removeaccess",level:3},{value:"No environment variables",id:"no-environment-variables-2",level:5},{value:"Positionnal arguments (deprecated)",id:"positionnal-arguments-deprecated-2",level:5},{value:"No waited return",id:"no-waited-return-4",level:5},{value:"Examples",id:"examples-4",level:5},{value:"Domain, certificates and DNS",id:"domain-certificates-and-dns",level:2},{value:"post_domain_add",id:"post_domain_add",level:3},{value:"No environment variable",id:"no-environment-variable",level:5},{value:"Positionnal arguments (deprecated)",id:"positionnal-arguments-deprecated-3",level:5},{value:"No waited return",id:"no-waited-return-5",level:5},{value:"Examples",id:"examples-5",level:5},{value:"post_domain_remove",id:"post_domain_remove",level:3},{value:"No environment variable",id:"no-environment-variable-1",level:5},{value:"Positionnal arguments (deprecated)",id:"positionnal-arguments-deprecated-4",level:5},{value:"No waited return",id:"no-waited-return-6",level:5},{value:"Examples",id:"examples-6",level:5},{value:"post_cert_update",id:"post_cert_update",level:3},{value:"No environment variable",id:"no-environment-variable-2",level:5},{value:"Positionnal arguments",id:"positionnal-arguments-1",level:5},{value:"No waited return",id:"no-waited-return-7",level:5},{value:"Examples",id:"examples-7",level:5},{value:"Restart a service after cert renewal",id:"restart-a-service-after-cert-renewal",level:6},{value:"custom_dns_rules",id:"custom_dns_rules",level:3},{value:"No environment variable",id:"no-environment-variable-3",level:5},{value:"Positionnal arguments",id:"positionnal-arguments-2",level:5},{value:"Waited return",id:"waited-return",level:5},{value:"Examples",id:"examples-8",level:5},{value:"Validate Let&#39;s Encrypt DNS challenge with a YunoHost DynDNS domain",id:"validate-lets-encrypt-dns-challenge-with-a-yunohost-dyndns-domain",level:6},{value:"Apps",id:"apps",level:2},{value:"post_app_change_url",id:"post_app_change_url",level:3},{value:"Environment variables",id:"environment-variables-2",level:5},{value:"No positionnal arguments",id:"no-positionnal-arguments-1",level:5},{value:"No waited return",id:"no-waited-return-8",level:5},{value:"Examples",id:"examples-9",level:5},{value:"post_app_upgrade",id:"post_app_upgrade",level:3},{value:"Environment variables",id:"environment-variables-3",level:5},{value:"No positionnal arguments",id:"no-positionnal-arguments-2",level:5},{value:"No waited return",id:"no-waited-return-9",level:5},{value:"Examples",id:"examples-10",level:5},{value:"Change a settings in an app config file (unmanaged by config panel)",id:"change-a-settings-in-an-app-config-file-unmanaged-by-config-panel",level:6},{value:"post_app_install",id:"post_app_install",level:3},{value:"Environment variables",id:"environment-variables-4",level:5},{value:"No positionnal arguments",id:"no-positionnal-arguments-3",level:5},{value:"No waited return",id:"no-waited-return-10",level:5},{value:"Examples",id:"examples-11",level:5},{value:"post_app_remove",id:"post_app_remove",level:3},{value:"Environment variables",id:"environment-variables-5",level:5},{value:"No positionnal arguments",id:"no-positionnal-arguments-4",level:5},{value:"No waited return",id:"no-waited-return-11",level:5},{value:"Examples",id:"examples-12",level:5},{value:"Backup / Restore",id:"backup--restore",level:2},{value:"backup",id:"backup",level:3},{value:"Environment variables",id:"environment-variables-6",level:5},{value:"Positionnal arguments",id:"positionnal-arguments-3",level:5},{value:"No waited return",id:"no-waited-return-12",level:5},{value:"Examples",id:"examples-13",level:5},{value:"Backup some files in more (for example your custom hooks)",id:"backup-some-files-in-more-for-example-your-custom-hooks",level:6},{value:"restore",id:"restore",level:3},{value:"Environment variables",id:"environment-variables-7",level:5},{value:"Positionnal arguments",id:"positionnal-arguments-4",level:5},{value:"No waited return",id:"no-waited-return-13",level:5},{value:"Examples",id:"examples-14",level:5},{value:"restore custom files",id:"restore-custom-files",level:6},{value:"backup_method",id:"backup_method",level:3},{value:"No environment variables",id:"no-environment-variables-3",level:5},{value:"Positionnal arguments",id:"positionnal-arguments-5",level:5},{value:"No waited return",id:"no-waited-return-14",level:5},{value:"Examples",id:"examples-15",level:5},{value:"A very simple backup on rotationnal disks",id:"a-very-simple-backup-on-rotationnal-disks",level:6},{value:"Configuration and firewall",id:"configuration-and-firewall",level:2},{value:"post_iptable_rules",id:"post_iptable_rules",level:3},{value:"No environment variables",id:"no-environment-variables-4",level:5},{value:"Positionnal arguments",id:"positionnal-arguments-6",level:5},{value:"No waited return",id:"no-waited-return-15",level:5},{value:"Examples",id:"examples-16",level:5},{value:"Forbid completely the outgoing 25 port except for postfix user",id:"forbid-completely-the-outgoing-25-port-except-for-postfix-user",level:6},{value:"conf_regen",id:"conf_regen",level:3},{value:"Environment variables",id:"environment-variables-8",level:5},{value:"Positionnal arguments",id:"positionnal-arguments-7",level:5},{value:"No waited return",id:"no-waited-return-16",level:5},{value:"Examples",id:"examples-17",level:5},{value:"Fix the warning about postfix compatibility mode in postfix logs",id:"fix-the-warning-about-postfix-compatibility-mode-in-postfix-logs",level:6}],d={toc:u},p="wrapper";function m(e){let{components:t,...a}=e;return(0,i.kt)(p,(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"YunoHost includes a hook mechanism triggered on a lot of operation changing the system. You can use this mechanism in order to extend the behaviour of a YunoHost command."),(0,i.kt)("p",null,"The most obvious case is adding a user. If you had a ",(0,i.kt)("inlineCode",{parentName:"p"},"post_user_create")," hook, this hook will be triggered as soon as a user is added."),(0,i.kt)("h2",{id:"how-to-add-a-custom-hook-on-a-specific-instance"},"How to add a custom hook on a specific instance"),(0,i.kt)("p",null,"!!! Below we imagine we want to run a command after each user creation to add the user to samba user."),(0,i.kt)("p",null,"You should create a directory with the name of the hooks into ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/yunohost/hooks.d/"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"mkdir -p /etc/yunohost/hooks.d/post_user_create\n")),(0,i.kt)("p",null,"Next create a bash script inside this directory prefixed by 2 numbers and a dash:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/yunohost/hooks.d/post_user_create/05-add-user-to-samba\n")),(0,i.kt)("p",null,"By default, the directory must be readable and traversable by root, but if you notice your hook is not run at all by YunoHost, you can check permissions with ",(0,i.kt)("inlineCode",{parentName:"p"},"ls -l /etc/yunohost/hooks.d/")," and apply these commands if needed:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"chown root:root /etc/yunohost/hooks.d/post_user_create\nchmod u+rx /etc/yunohost/hooks.d/post_user_create\n")),(0,i.kt)("h2",{id:"how-to-add-a-hook-in-an-app-package"},"How to add a hook in an app package"),(0,i.kt)("p",null,"If you are packaging an app, you should not set by yourself the hook into ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/yunohost/hooks.d")," instead you should create a hooks dir at the root of your package."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},".\n\u251c\u2500\u2500 conf\n\u251c\u2500\u2500 hooks\n\u251c\u2500\u2500 scripts\n")),(0,i.kt)("p",null,"In the hooks dir, create a bash script called with the type of hook you want to create for example ",(0,i.kt)("inlineCode",{parentName:"p"},"post_create_user"),"."),(0,i.kt)("h2",{id:"hooks-referencies"},"Hooks referencies"),(0,i.kt)("h3",{id:"user-and-permissions"},"User and permissions"),(0,i.kt)("h4",{id:"post_user_create"},"post_user_create"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered after user creation"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost user create")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"environment-variables"},"Environment variables"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"YNH_USER_USERNAME: The username of the created user"),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_MAIL: The mail of the created user"),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_PASSWORD: The ",(0,i.kt)("strong",{parentName:"li"},"clear")," password of the created user"),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_FIRSTNAME: The firstname of the created user (",(0,i.kt)("a",{parentName:"li",href:"https://github.com/YunoHost/issues/issues/296"},"should be removed in future"),")"),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_LASTNAME: The lastname of the created user (",(0,i.kt)("a",{parentName:"li",href:"https://github.com/YunoHost/issues/issues/296"},"should be removed in future"),")")),(0,i.kt)("h5",{id:"positionnal-arguments-deprecated"},"Positionnal arguments (deprecated)"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The username of the created user"),(0,i.kt)("li",{parentName:"ul"},"$2: The mail of the created user")),(0,i.kt)("h5",{id:"no-waited-return"},"No waited return"),(0,i.kt)("h5",{id:"examples"},"Examples"),(0,i.kt)("h6",{id:"send-automatically-a-mail-to-new-user"},"Send automatically a mail to new user"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\ndomain=$(cat /etc/hostname)\n\nmessage="Hello $YNH_USER_FIRSTNAME,\nWelcome on $domain ! \nFeel free to <a href=\'https://$domain/yunohost/sso/edit.html\'>change your password</a>.\nLet me know if you have a problem,\nThe admin of $domain\n"\n\necho $message | mail -s "Welcome on $domain !" $YNH_USER_MAIL\n')),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h4",{id:"post_user_delete"},"post_user_delete"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered at the end of user deletion"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost user delete")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"no-environment-variables"},"No environment variables"),(0,i.kt)("h5",{id:"positionnal-arguments"},"Positionnal arguments"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The username of the user deleted"),(0,i.kt)("li",{parentName:"ul"},"$2: True if --purge option is used")),(0,i.kt)("h5",{id:"no-waited-return-1"},"No waited return"),(0,i.kt)("h5",{id:"examples-1"},"Examples"),(0,i.kt)("h6",{id:""}),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\n")),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"post_user_update"},"post_user_update"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered at the end of the user update"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost user update")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"environment-variables-1"},"Environment variables"),(0,i.kt)("p",null,"! Only arguments given to the cli/api are given as environment variable."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"YNH_USER_USERNAME: The username of the updated user"),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_FIRSTNAME: The firstname of the updated user (",(0,i.kt)("a",{parentName:"li",href:"https://github.com/YunoHost/issues/issues/296"},"should be removed in future"),")"),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_LASTNAME: The lastname of the updated user (",(0,i.kt)("a",{parentName:"li",href:"https://github.com/YunoHost/issues/issues/296"},"should be removed in future"),")"),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_PASSWORD: The new password of the updated user"),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_MAILS: The mail and mail aliases of the updated user seperated by comma"),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_MAILFORWARDS: The list of forward mails of the updated user separated by comma "),(0,i.kt)("li",{parentName:"ul"},"YNH_USER_MAILQUOTA: The quota of the updated user (could be 0 or a number following by one of this unit: b, k, M, G or T)")),(0,i.kt)("h5",{id:"no-positionnal-arguments"},"No positionnal arguments"),(0,i.kt)("h5",{id:"no-waited-return-2"},"No waited return"),(0,i.kt)("h5",{id:"examples-2"},"Examples"),(0,i.kt)("h6",{id:"send-a-mail-on-password-changing"},"Send a mail on password changing"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n"\ndomain=$(cat /etc/hostname)\n\nmessage="Hello,\nYour password has been successfully changed on $domain.\nIf you have not asked for changing your password, you probably should contact the admin of $domain.\n"\n\necho $message | mail -s "Your password has been changed on $domain !" $YNH_USER_USERNAME\n')),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"post_app_addaccess"},"post_app_addaccess"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered after adding a permission to users or groups "),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost user permission add")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"no-environment-variables-1"},"No environment variables"),(0,i.kt)("h5",{id:"positionnal-arguments-deprecated-1"},"Positionnal arguments (deprecated)"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The app name"),(0,i.kt)("li",{parentName:"ul"},"$2: The list of users added separated by comma"),(0,i.kt)("li",{parentName:"ul"},"$3: The name of the sub permission (",(0,i.kt)("inlineCode",{parentName:"li"},"main"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"admin"),", etc.)"),(0,i.kt)("li",{parentName:"ul"},"$4: The list of groups added separated by comma")),(0,i.kt)("h5",{id:"no-waited-return-3"},"No waited return"),(0,i.kt)("h5",{id:"examples-3"},"Examples"),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"post_app_removeaccess"},"post_app_removeaccess"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered after removing a pemission to users or groups"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost user permission remove")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"no-environment-variables-2"},"No environment variables"),(0,i.kt)("h5",{id:"positionnal-arguments-deprecated-2"},"Positionnal arguments (deprecated)"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The app name"),(0,i.kt)("li",{parentName:"ul"},"$2: The list of users removed from the permission separated by comma"),(0,i.kt)("li",{parentName:"ul"},"$3: The name of the sub permission (",(0,i.kt)("inlineCode",{parentName:"li"},"main"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"admin"),", etc.)"),(0,i.kt)("li",{parentName:"ul"},"$4: The list of groups removed from the permission separated by comma")),(0,i.kt)("h5",{id:"no-waited-return-4"},"No waited return"),(0,i.kt)("h5",{id:"examples-4"},"Examples"),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h2",{id:"domain-certificates-and-dns"},"Domain, certificates and DNS"),(0,i.kt)("h3",{id:"post_domain_add"},"post_domain_add"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered at the end of the domain add operation"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost domain add")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"no-environment-variable"},"No environment variable"),(0,i.kt)("h5",{id:"positionnal-arguments-deprecated-3"},"Positionnal arguments (deprecated)"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The domain added ")),(0,i.kt)("h5",{id:"no-waited-return-5"},"No waited return"),(0,i.kt)("h5",{id:"examples-5"},"Examples"),(0,i.kt)("h6",{id:"-1"}),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"")),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"post_domain_remove"},"post_domain_remove"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered after removing the domain"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost domain remove")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"no-environment-variable-1"},"No environment variable"),(0,i.kt)("h5",{id:"positionnal-arguments-deprecated-4"},"Positionnal arguments (deprecated)"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The domain removed")),(0,i.kt)("h5",{id:"no-waited-return-6"},"No waited return"),(0,i.kt)("h5",{id:"examples-6"},"Examples"),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"post_cert_update"},"post_cert_update"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered after Let's encrypt certificate update"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost domain cert update")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"no-environment-variable-2"},"No environment variable"),(0,i.kt)("h5",{id:"positionnal-arguments-1"},"Positionnal arguments"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The domain for which we have updated the certificate")),(0,i.kt)("h5",{id:"no-waited-return-7"},"No waited return"),(0,i.kt)("h5",{id:"examples-7"},"Examples"),(0,i.kt)("h6",{id:"restart-a-service-after-cert-renewal"},"Restart a service after cert renewal"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\nsystemctl restart gemserv\n")),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"custom_dns_rules"},"custom_dns_rules"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Customized your DNS rules for your domains"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost domain dns suggest")," or equivalent action in webadmin."),(0,i.kt)("p",null,"Thanks to This hook you can customize "),(0,i.kt)("h5",{id:"no-environment-variable-3"},"No environment variable"),(0,i.kt)("h5",{id:"positionnal-arguments-2"},"Positionnal arguments"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The base domain for which we want to build a DNS suggestion")),(0,i.kt)("h5",{id:"waited-return"},"Waited return"),(0,i.kt)("p",null,"The script should return a JSON array with dictionnary in this format:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},"[\n    {\n        'type': 'SRV',\n        'name': 'stuff.foo.bar',\n        'value': 'yoloswag',\n        'ttl': 3600\n    }\n]\n")),(0,i.kt)("h5",{id:"examples-8"},"Examples"),(0,i.kt)("h6",{id:"validate-lets-encrypt-dns-challenge-with-a-yunohost-dyndns-domain"},"Validate Let's Encrypt DNS challenge with a YunoHost DynDNS domain"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\nif [[ \"$1\" == \"XXXX.nohost.me\" ]] ; then\n    echo \"[\n        {\n            'type': 'TXT',\n            'name': '_acme-challenge',\n            'value': 'LETSENCRYPT_VALUE',\n            'ttl': 3600\n        }\n    ]\"\nfi\n\n")),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h2",{id:"apps"},"Apps"),(0,i.kt)("h3",{id:"post_app_change_url"},"post_app_change_url"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered after an app has changed of URL"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost app change-url")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"environment-variables-2"},"Environment variables"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"YNH_APP_OLD_DOMAIN: The old domain of the app"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_OLD_PATH: The old path of the app"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_NEW_DOMAIN: The new domain of the app"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_NEW_PATH: The new path of the app")),(0,i.kt)("h5",{id:"no-positionnal-arguments-1"},"No positionnal arguments"),(0,i.kt)("h5",{id:"no-waited-return-8"},"No waited return"),(0,i.kt)("h5",{id:"examples-9"},"Examples"),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"post_app_upgrade"},"post_app_upgrade"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered on app upgrade"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost app upgrade")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"environment-variables-3"},"Environment variables"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"YNH_APP_ID: The app id (for example nextcloud)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_INSTANCE_NAME: The app instance name (for example nextcloud__2)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_INSTANCE_NUMBER: The app instance number (for example 2)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_MANIFEST_VERSION: The app manifest version (for example 1 or ?)"),(0,i.kt)("li",{parentName:"ul"},"YNH_ARCH: The arch as returned by ",(0,i.kt)("inlineCode",{parentName:"li"},"dpkg --print-architecture")),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_UPGRADE_TYPE: The type of upgrade (UPGRADE_PACKAGE, UPGRADE_APP, UPGRADE_FULL)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_MANIFEST_VERSION: The version number "),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_CURRENT_VERSION: The version number of the app (in the yunohost format)"),(0,i.kt)("li",{parentName:"ul"},"NO_BACKUP_UPGRADE: 1 if we don't want to backup else 0")),(0,i.kt)("h5",{id:"no-positionnal-arguments-2"},"No positionnal arguments"),(0,i.kt)("h5",{id:"no-waited-return-9"},"No waited return"),(0,i.kt)("h5",{id:"examples-10"},"Examples"),(0,i.kt)("h6",{id:"change-a-settings-in-an-app-config-file-unmanaged-by-config-panel"},"Change a settings in an app config file (unmanaged by config panel)"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nsource /usr/share/yunohost/helpers\napp=$YNH_APP_INSTANCE_NAME\n\nif [[ "$app" == "etherpad_mypads" ]]; then\n  ynh_write_var_in_file --file=/var/www/etherpad_mypads/settings.json --key=max --value=100 --after=importExportRateLimiting\n  systemctl restart etherpad_mypads\nfi\n\n')),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"post_app_install"},"post_app_install"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered at the end of an app installation"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost app install")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"environment-variables-4"},"Environment variables"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"YNH_APP_ID: The app id (for example nextcloud)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_INSTANCE_NAME: The app instance name (for example nextcloud__2)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_INSTANCE_NUMBER: The app instance number (for example 2)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_MANIFEST_VERSION: The app manifest version (for example 1 or ?)"),(0,i.kt)("li",{parentName:"ul"},"YNH_ARCH: The arch as returned by ",(0,i.kt)("inlineCode",{parentName:"li"},"dpkg --print-architecture")),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_ARG_XXXXXXX: The argument of the manifest")),(0,i.kt)("h5",{id:"no-positionnal-arguments-3"},"No positionnal arguments"),(0,i.kt)("h5",{id:"no-waited-return-10"},"No waited return"),(0,i.kt)("h5",{id:"examples-11"},"Examples"),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"post_app_remove"},"post_app_remove"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered after removing an app"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost app remove")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"environment-variables-5"},"Environment variables"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"YNH_APP_ID: The app id (for example nextcloud)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_INSTANCE_NAME: The app instance name (for example nextcloud__2)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_INSTANCE_NUMBER: The app instance number (for example 2)"),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_MANIFEST_VERSION: The app manifest version (for example 1 or ?)"),(0,i.kt)("li",{parentName:"ul"},"YNH_ARCH: The arch as returned by ",(0,i.kt)("inlineCode",{parentName:"li"},"dpkg --print-architecture")),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_PURGE: 1 if the --purge option has been activated")),(0,i.kt)("h5",{id:"no-positionnal-arguments-4"},"No positionnal arguments"),(0,i.kt)("h5",{id:"no-waited-return-11"},"No waited return"),(0,i.kt)("h5",{id:"examples-12"},"Examples"),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h2",{id:"backup--restore"},"Backup / Restore"),(0,i.kt)("h3",{id:"backup"},"backup"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Add some files to backup"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost backup create")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"environment-variables-6"},"Environment variables"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"YNH_BACKUP_DIR: The work dir in which we can store temporary data to backup like database dump"),(0,i.kt)("li",{parentName:"ul"},"YNH_BACKUP_CSV: The CSV in which we add the things to backup. Don't use this directly and use ynh_backup helper instead."),(0,i.kt)("li",{parentName:"ul"},"YNH_APP_BACKUP_DIR: To document")),(0,i.kt)("h5",{id:"positionnal-arguments-3"},"Positionnal arguments"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The work dir in which we can store temporary data to backup like database dump")),(0,i.kt)("h5",{id:"no-waited-return-12"},"No waited return"),(0,i.kt)("h5",{id:"examples-13"},"Examples"),(0,i.kt)("h6",{id:"backup-some-files-in-more-for-example-your-custom-hooks"},"Backup some files in more (for example your custom hooks)"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\n# Source YNH helpers\nsource /usr/share/yunohost/helpers\n\nynh_backup_dest (){\n    YNH_CWD="${YNH_BACKUP_DIR%/}/$1"\n    mkdir -p $YNH_CWD\n    cd "$YNH_CWD"\n}\n\n# Exit hook on subcommand error or unset variable\nynh_abort_if_errors\n\n# MISC\nynh_backup_dest "conf/custom/misc"\nynh_backup "/etc/sysctl.d/noipv6.conf"\nynh_backup "/usr/local/bin/"\n\nynh_backup "/etc/yunohost/hooks.d/backup/99-conf_custom"\nynh_backup "/etc/yunohost/hooks.d/restore/99-conf_custom"\n\n')),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"restore"},"restore"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Restore some files"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost backup restore")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"environment-variables-7"},"Environment variables"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"YNH_BACKUP_DIR: The work dir in which we can store temporary data to backup like database dump"),(0,i.kt)("li",{parentName:"ul"},"YNH_BACKUP_CSV: The CSV in which we add the things to backup. Don't use this directly and use ynh_backup helper instead.")),(0,i.kt)("h5",{id:"positionnal-arguments-4"},"Positionnal arguments"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The work dir in which we can store temporary data to backup like database dump")),(0,i.kt)("h5",{id:"no-waited-return-13"},"No waited return"),(0,i.kt)("h5",{id:"examples-14"},"Examples"),(0,i.kt)("h6",{id:"restore-custom-files"},"restore custom files"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\n# Source YNH helpers\nsource /usr/share/yunohost/helpers\n\nynh_restore_dest (){\n    YNH_CWD="${YNH_BACKUP_DIR%/}/$1"\n    cd "$YNH_CWD"\n}\n\n# Exit hook on subcommand error or unset variable\nynh_abort_if_errors\n\n# MISC\nynh_restore_dest "conf/custom/misc"\nynh_restore_file "/etc/sysctl.d/noipv6.conf"\nynh_restore_file "/usr/local/bin/"\n\nynh_restore_file "/etc/yunohost/hooks.d/backup/99-conf_custom"\nynh_restore_file "/etc/yunohost/hooks.d/restore/99-conf_custom"\n\n\n')),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"backup_method"},"backup_method"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Define a new way to backup and restore files"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run during the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost backup create")," or equivalent action in webadmin."),(0,i.kt)("p",null,"This hook is called several times with different action keywords."),(0,i.kt)("h5",{id:"no-environment-variables-3"},"No environment variables"),(0,i.kt)("h5",{id:"positionnal-arguments-5"},"Positionnal arguments"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},'$1: The action ("need_mount", "backup", "mount")'),(0,i.kt)("li",{parentName:"ul"},"$2: The work dir"),(0,i.kt)("li",{parentName:"ul"},"$3: The name of the backup"),(0,i.kt)("li",{parentName:"ul"},"$4: The repository in which the backup should be done"),(0,i.kt)("li",{parentName:"ul"},"$5: An estimation size of the files to backup"),(0,i.kt)("li",{parentName:"ul"},"$6: A description of the archive")),(0,i.kt)("h5",{id:"no-waited-return-14"},"No waited return"),(0,i.kt)("h5",{id:"examples-15"},"Examples"),(0,i.kt)("h6",{id:"a-very-simple-backup-on-rotationnal-disks"},"A very simple backup on rotationnal disks"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\nset -euo pipefail\n\nwork_dir="$2"\nname="$3"\nrepo="$4"\nsize="$5"\ndescription="$6"\n\ncase "$1" in\n  need_mount)\n    # Set false if your method can itself put files in good place in your archive\n    true\n    ;;\n  backup)\n    mount /dev/sda1 /mnt/hdd\n    if [[ "$(df /mnt/hdd | tail -n1 | cut -d" " -f1)" != "/dev/sda1" ]]\n    then\n        exit 1\n    fi\n    pushd "$work_dir"\n    current_date=$(date +"%Y-%m-%d_%H:%M")\n    cp -a "${work_dir}" "/mnt/hdd/${current_date}_$name"\n    popd\n    umount /mnt/hdd\n    ;;\n  *)\n    echo "hook called with unknown argument \\`$1\'" >&2\n    exit 1\n    ;;\nesac\n\nexit 0\n\n')),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h2",{id:"configuration-and-firewall"},"Configuration and firewall"),(0,i.kt)("h3",{id:"post_iptable_rules"},"post_iptable_rules"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Triggered after reloaded the firewall rules"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run at the end of the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost firewall reload")," or equivalent action in webadmin."),(0,i.kt)("h5",{id:"no-environment-variables-4"},"No environment variables"),(0,i.kt)("h5",{id:"positionnal-arguments-6"},"Positionnal arguments"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: True if upnp has succeeded "),(0,i.kt)("li",{parentName:"ul"},"$2: True if ipv6 is available")),(0,i.kt)("h5",{id:"no-waited-return-15"},"No waited return"),(0,i.kt)("h5",{id:"examples-16"},"Examples"),(0,i.kt)("h6",{id:"forbid-completely-the-outgoing-25-port-except-for-postfix-user"},"Forbid completely the outgoing 25 port except for postfix user"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"#!/bin/bash\niptables -A OUTPUT -p tcp --dport 25 -m owner --uid-owner postfix -j ACCEPT\niptables -A OUTPUT -p tcp --dport 25 -m tcp -j REJECT --reject-with icmp-port-unreachable\n")),(0,i.kt)("p",null,"[/details]"),(0,i.kt)("h3",{id:"conf_regen"},"conf_regen"),(0,i.kt)("p",null,'[details summary="',(0,i.kt)("i",null,"Change configuration suggested as default config in regen-conf mechanism"),'" class="helper-card-subtitle text-muted"]'),(0,i.kt)("p",null,"This hook is run during the command ",(0,i.kt)("inlineCode",{parentName:"p"},"yunohost tools regen-conf")," or equivalent action in webadmin."),(0,i.kt)("p",null,"This hook is called several times with different actions keywords (pre and post operations)."),(0,i.kt)("h5",{id:"environment-variables-8"},"Environment variables"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"YNH_DOMAINS: The list of domains managed by YunoHost separated by comma"),(0,i.kt)("li",{parentName:"ul"},"YNH_MAIN_DOMAINS: The list of main domains separated by comma")),(0,i.kt)("h5",{id:"positionnal-arguments-7"},"Positionnal arguments"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"$1: The pre or post action"),(0,i.kt)("li",{parentName:"ul"},"$2: Empty string due to legacy"),(0,i.kt)("li",{parentName:"ul"},"$3: Empty string due to legacy"),(0,i.kt)("li",{parentName:"ul"},"$4: In post mode the list of file which should be modified. In pre mode the dir in which we store pending configuration")),(0,i.kt)("h5",{id:"no-waited-return-16"},"No waited return"),(0,i.kt)("h5",{id:"examples-17"},"Examples"),(0,i.kt)("h6",{id:"fix-the-warning-about-postfix-compatibility-mode-in-postfix-logs"},"Fix the warning about postfix compatibility mode in postfix logs"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\naction=$1\npending_dir=$4\npostfix_conf=$pending_dir/../postfix/etc/postfix/main.cf\n\n[[ "$action" == "pre" ]] || exit 0\n[[ -e $postfix_conf ]] || exit 0\necho \'\ncompatibility_level = 2\' >> $postfix_conf\n')),(0,i.kt)("p",null,"[/details]"))}m.isMDXComponent=!0}}]);