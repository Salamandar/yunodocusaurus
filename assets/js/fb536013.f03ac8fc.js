"use strict";(self.webpackChunkyunohost_docs=self.webpackChunkyunohost_docs||[]).push([[4151],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(n),m=i,h=d["".concat(l,".").concat(m)]||d[m]||u[m]||o;return n?a.createElement(h,r(r({ref:t},c),{},{components:n})):a.createElement(h,r({ref:t},c))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:i,r[1]=s;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},49161:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(87462),i=(n(67294),n(3905));const o={title:"Writing app scripts",template:"docs",taxonomy:{category:"docs"},routes:{default:"/packaging_scripts"}},r=void 0,s={unversionedId:"contribute/packaging_apps/scripts",id:"contribute/packaging_apps/scripts",title:"Writing app scripts",description:"App scripts are the essential logic defining what happens when an app is installed, removed, upgraded, backuped, or restored. They are written in Bash) which is the same stuff you type in interactive mode in a terminal, though we added a bunch of custom YunoHost functions that we call helpers to standardize many common operations - for example adding the nginx configuration.",source:"@site/docs/06.contribute/10.packaging_apps/20.scripts.md",sourceDirName:"06.contribute/10.packaging_apps",slug:"/contribute/packaging_apps/scripts",permalink:"/yunodocusaurus/docs/contribute/packaging_apps/scripts",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/06.contribute/10.packaging_apps/20.scripts.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{title:"Writing app scripts",template:"docs",taxonomy:{category:"docs"},routes:{default:"/packaging_scripts"}},sidebar:"tutorialSidebar",previous:{title:"Writing the app manifest",permalink:"/yunodocusaurus/docs/contribute/packaging_apps/manifest"},next:{title:"Adding documentation to your app",permalink:"/yunodocusaurus/docs/contribute/packaging_apps/doc"}},l={},p=[{value:"Variables available in a script context",id:"variables-available-in-a-script-context",level:2},{value:"Setting system",id:"setting-system",level:2},{value:"Helper system",id:"helper-system",level:2},{value:"Configuration/template system",id:"configurationtemplate-system",level:2},{value:"App sources",id:"app-sources",level:2},{value:"Common operations (TODO/FIXME)",id:"common-operations-todofixme",level:2},{value:"installing/upgrading app sources",id:"installingupgrading-app-sources",level:4},{value:"adding configurations",id:"adding-configurations",level:4},{value:"adding a systemd service",id:"adding-a-systemd-service",level:4},{value:"curl / automatizing install forms",id:"curl--automatizing-install-forms",level:4},{value:"classic stuff for nodejs apps",id:"classic-stuff-for-nodejs-apps",level:4},{value:"classic stuff for php apps",id:"classic-stuff-for-php-apps",level:4},{value:"classic stuff for python apps",id:"classic-stuff-for-python-apps",level:4},{value:"classic stuff for ??? apps",id:"classic-stuff-for--apps",level:4}],c={toc:p},d="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(d,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"App scripts are the essential logic defining what happens when an app is ",(0,i.kt)("inlineCode",{parentName:"p"},"install"),"ed, ",(0,i.kt)("inlineCode",{parentName:"p"},"remove"),"d, ",(0,i.kt)("inlineCode",{parentName:"p"},"upgrade"),"d, ",(0,i.kt)("inlineCode",{parentName:"p"},"backup"),"ed, or ",(0,i.kt)("inlineCode",{parentName:"p"},"restore"),"d. They are written in ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Bash_(Unix_shell)"},"Bash")," which is the same stuff you type in interactive mode in a terminal, though we added a bunch of custom YunoHost functions that we call ",(0,i.kt)("inlineCode",{parentName:"p"},"helpers")," to standardize many common operations - for example adding the nginx configuration."),(0,i.kt)("p",null,"Note that starting from packaging v2, the logic or what happens when an app is installed, etc. is also contained partially in the resource configuration in the ",(0,i.kt)("inlineCode",{parentName:"p"},"manifest.toml"),"."),(0,i.kt)("p",null,"In the ",(0,i.kt)("inlineCode",{parentName:"p"},"scripts")," folder of an app, you can expect to find:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},'manifest.toml\nscripts/\n   - _common.sh   # Some "common" definition, typically custom helpers or global variables used accross all scripts\n   - install      # The install procedure\n   - remove       # The remove procedure\n   - upgrade      # The upgrade procedure\n   - backup       # The backup procedure - in fact it only "declares" what should be backup / no actual real backup happens at this point except dumping SQL databases\n   - restore      # The restore procedure\n   - change_url   # Some apps do also provide a change url script, which corresponds to changing the URL endpoint of the app, which may be as simple as changing the nginx conf, or may involve significant changes in the app DB\n')),(0,i.kt)("p",null,"Here is an example of the simple install script for the ",(0,i.kt)("inlineCode",{parentName:"p"},"helloworld")," app:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\n# This is where we load the official YunoHost helpers\nsource /usr/share/yunohost/helpers\n\n#=================================================\n# DOWNLOAD, CHECK AND UNPACK SOURCE\n# This is where we would usually fetch the .tar.gz archive \n# from the upstream and extract it into our local install dir\n#=================================================\n# At the beginning of each major operation, we call this helper\n# that creates a progress bar\nynh_script_progression --message="Setting up source files..." --weight=1\n\necho "Hello world!" > $install_dir/index.html\nchown -R www-data: "$install_dir"\n\n#=================================================\n# NGINX CONFIGURATION\n# This is where the nginx conf snippet for the app is created using the\n# configuration template provided in conf/nginx.conf\n# and added to /etc/nginx/conf.d/$domain.d/$app.conf\n#=================================================\nynh_script_progression --message="Configuring nginx web server..." --weight=1\n\nynh_add_nginx_config\n')),(0,i.kt)("p",null,"Note that the scripts are run with the ",(0,i.kt)("inlineCode",{parentName:"p"},"set -eu")," options (except for the remove script), which means that any failing command or use of non-existing variable will trigger an error and stop the script execution."),(0,i.kt)("h2",{id:"variables-available-in-a-script-context"},"Variables available in a script context"),(0,i.kt)("p",null,"Special variables are automatically defined in the context of a script:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"$app")," is the app ID. It will typically be the ID from the app's manifest.toml, for example ",(0,i.kt)("inlineCode",{parentName:"li"},"helloworld"),", but will be ",(0,i.kt)("inlineCode",{parentName:"li"},"helloworld__2"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"__3")," etc for multi-instance installs."),(0,i.kt)("li",{parentName:"ul"},"During install, answers to install questions are automatically available as bash variables. For example, the ",(0,i.kt)("inlineCode",{parentName:"li"},"$domain")," setting corresponds to the ",(0,i.kt)("inlineCode",{parentName:"li"},"domain")," question, same for ",(0,i.kt)("inlineCode",{parentName:"li"},"$prefered_pet"),", etc... Note that - apart from special questions such as ",(0,i.kt)("inlineCode",{parentName:"li"},"init_main_permission")," or user-provided passwords - they are also automatically saved as settings (cf next section)."),(0,i.kt)("li",{parentName:"ul"},"During other scripts, all app settings are also loaded and automatically available."),(0,i.kt)("li",{parentName:"ul"},"Note that some settings are automatically created/updated by app ressources. For example, the ",(0,i.kt)("inlineCode",{parentName:"li"},"install_dir")," setting will automatically be available too and corresponds to typically ",(0,i.kt)("inlineCode",{parentName:"li"},"/var/www/$app")),(0,i.kt)("li",{parentName:"ul"},"In the ",(0,i.kt)("inlineCode",{parentName:"li"},"change_url")," context, variables called ",(0,i.kt)("inlineCode",{parentName:"li"},"new_domain"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"new_path"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"old_domain"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"old_path")," will be available, as well as ",(0,i.kt)("inlineCode",{parentName:"li"},"change_domain")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"change_path")," equal to ",(0,i.kt)("inlineCode",{parentName:"li"},"0")," (false) or ",(0,i.kt)("inlineCode",{parentName:"li"},"1")," (true) depending if the domain / path changed")),(0,i.kt)("h2",{id:"setting-system"},"Setting system"),(0,i.kt)("p",null,'Application often need to store long term information in between scripts triggered by the admin. For this, YunoHost has a key-value store for each application called "setting" and is stored in ',(0,i.kt)("inlineCode",{parentName:"p"},"/etc/yunohost/apps/$app/settings.yml"),"."),(0,i.kt)("p",null,"Apps can interact with this key value store in this way:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'# Retrieve a setting into variable "db_name"\ndb_name=$(ynh_app_setting_get --app=$app --key=db_name)\n\n# Update a setting\nynh_app_setting_set --app=$app --key=db_name --value=$db_name\n')),(0,i.kt)("h2",{id:"helper-system"},"Helper system"),(0,i.kt)("p",null,"We call helpers a set of custom bash function created by the YunoHost project to standardize common operations accross all apps. They are all prefixed with ",(0,i.kt)("inlineCode",{parentName:"p"},"ynh_"),". The full list and documentation of these helpers is available on ",(0,i.kt)("a",{parentName:"p",href:"/packaging_apps_helpers"},"this page"),". Some of these helpers are now partially obsolete as they are now handled by the core via app resources."),(0,i.kt)("p",null,"Here is the list of the major ones:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ynh_app_setting_get")," / ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_app_setting_set")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ynh_script_progression")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ynh_setup_source")),(0,i.kt)("li",{parentName:"ul"},"nginx: ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_add_nginx_config")," / ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_remove_nginx_config")),(0,i.kt)("li",{parentName:"ul"},"php: ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_add_fpm_config")," / ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_remove_fpm_config")),(0,i.kt)("li",{parentName:"ul"},"systemd: ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_add_systemd_config")," / ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_remove_systemd_config")),(0,i.kt)("li",{parentName:"ul"},"fail2ban: ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_add_fail2ban_config")," / ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_remove_fail2ban_config")),(0,i.kt)("li",{parentName:"ul"},"custom: ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_add_config")),(0,i.kt)("li",{parentName:"ul"},"nodejs: ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_install_nodejs")," / ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_use_nodejs")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ynh_exec_warn_less")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ynh_local_curl")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ynh_secure_remove")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ynh_backup")," / ",(0,i.kt)("inlineCode",{parentName:"li"},"ynh_restore_file"))),(0,i.kt)("h2",{id:"configurationtemplate-system"},"Configuration/template system"),(0,i.kt)("p",null,"App scripts will often need to create a bunch of configuration files."),(0,i.kt)("p",null,"Configuration templates are canonically stored provided in the ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/")," folder of the app, such as ",(0,i.kt)("inlineCode",{parentName:"p"},"nginx.conf"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"extra_php-fpm.conf"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"systemd.conf"),", or ",(0,i.kt)("inlineCode",{parentName:"p"},"some-custom-app-conf.env")," ..."),(0,i.kt)("p",null,"In these templates, you can use the syntax ",(0,i.kt)("inlineCode",{parentName:"p"},"__FOOBAR__")," which will automatically be replaced by the variable ",(0,i.kt)("inlineCode",{parentName:"p"},"$foobar")," during runtime, when the conf is installed via the ",(0,i.kt)("inlineCode",{parentName:"p"},"ynh_add_*_config")," helpers."),(0,i.kt)("p",null,"For example, an app's NGINX conf snippet may look like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"# The next line starting with '#sub_path_only' is automatically uncommented only when $path is not /\n#sub_path_only rewrite ^__PATH__$ __PATH__/ permanent;\nlocation __PATH__/ {\n\n  alias __INSTALL_DIR__/;\n\n  # Some headers and tweaks\n\n}\n")),(0,i.kt)("h2",{id:"app-sources"},"App sources"),(0,i.kt)("p",null,"App sources were historically defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"conf/app.src")," files containing the URL + checksum of assets to download."),(0,i.kt)("p",null,"This is now integrated in ",(0,i.kt)("inlineCode",{parentName:"p"},"manifest.toml")," using the ",(0,i.kt)("inlineCode",{parentName:"p"},"sources")," resource, which pre-download the assets prior to entering the install or upgrade scripts. The sources can then be effectively deployed using ",(0,i.kt)("inlineCode",{parentName:"p"},"ynh_setup_source"),"."),(0,i.kt)("p",null,"For example, for YesWiki, the sources are defined in ",(0,i.kt)("inlineCode",{parentName:"p"},"manifest.toml")," using:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-toml"},'[resources.sources.main]\nurl = "https://github.com/YesWiki/yeswiki/archive/refs/tags/v4.4.0.tar.gz"\nsha256 = "5ceb12d225c20de2ba3cb4ce483348ed1a8ad5b1789d4f4f8f89dc4871524007"\n')),(0,i.kt)("p",null,"More infos on the ",(0,i.kt)("inlineCode",{parentName:"p"},"source")," resource in ",(0,i.kt)("a",{parentName:"p",href:"/packaging_apps_resources"},"the resource system documentation"),"."),(0,i.kt)("h2",{id:"common-operations-todofixme"},"Common operations (TODO/FIXME)"),(0,i.kt)("h4",{id:"installingupgrading-app-sources"},"installing/upgrading app sources"),(0,i.kt)("h4",{id:"adding-configurations"},"adding configurations"),(0,i.kt)("h4",{id:"adding-a-systemd-service"},"adding a systemd service"),(0,i.kt)("h4",{id:"curl--automatizing-install-forms"},"curl / automatizing install forms"),(0,i.kt)("h4",{id:"classic-stuff-for-nodejs-apps"},"classic stuff for nodejs apps"),(0,i.kt)("h4",{id:"classic-stuff-for-php-apps"},"classic stuff for php apps"),(0,i.kt)("h4",{id:"classic-stuff-for-python-apps"},"classic stuff for python apps"),(0,i.kt)("h4",{id:"classic-stuff-for--apps"},"classic stuff for ??? apps"))}u.isMDXComponent=!0}}]);